<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Polling Test</title>
</head>
<body>
    <h1>Dashboard Polling Test</h1>
    <p>Check the browser console for output</p>
    
    <div>
        <button onclick="testCommandHistoryLoading()">Test Command History Loading</button>
        <button onclick="startPolling()">Start 5s Polling</button>
        <button onclick="stopPolling()">Stop Polling</button>
    </div>

    <script>
        // Mock variables that the dashboard expects
        let currentAgentId = 'test-agent';
        let lastSeenCommandIds = new Set();
        window.agentName = 'test-agent';

        // Simple test function
        function loadCommandHistory() {
            console.log('=== loadCommandHistory function started ===');
            const queueId = window.agentName || currentAgentId;
            
            console.log('loadCommandHistory called - queueId:', queueId, 'window.agentName:', window.agentName, 'currentAgentId:', currentAgentId);
            
            if (!queueId) {
                console.log('ERROR: No queueId available, skipping command history load');
                return;
            }
            
            console.log('SUCCESS: Making API call to:', `/commands/agent/${queueId}/history`);
            
            fetch(`/commands/agent/${queueId}/history`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
                }
            })
            .then(response => {
                console.log('Response received:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error('Failed to load command history');
                }
                return response.json();
            })
            .then(data => {
                console.log('Command history data:', data);
            })
            .catch(error => {
                console.error('Error loading command history:', error);
            });
        }

        function testCommandHistoryLoading() {
            console.log('=== MANUAL TEST: testCommandHistoryLoading ===');
            loadCommandHistory();
        }

        let pollingInterval = null;

        function startPolling() {
            console.log('Starting 5-second polling...');
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            pollingInterval = setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] Polling interval triggered`);
                loadCommandHistory();
            }, 5000);
            
            console.log('Polling started with interval ID:', pollingInterval);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('Polling stopped');
            }
        }

        // Auto-start polling
        window.addEventListener('load', () => {
            console.log('Page loaded, testing immediate call...');
            loadCommandHistory();
        });
    </script>
</body>
</html>